---
title: "amsterdam_predicton"
author: "Fasih Atif"
date: "1/30/2021"
output:
  html_document:
    df_print: paged
  rmarkdown::html_document:
    theme: tactile
---

```{r libraries, echo= FALSE, message=FALSE, warning=FALSE}
# Import libraries
library(dplyr)
library(tidyverse)
library(data.table)
library(stringr)  
library(fastDummies)
library(ggpubr)
library(scales)
```

```{r Import data, message=FALSE, warning=FALSE, include=FALSE}
# Import data

listings <- read.csv("https://raw.githubusercontent.com/fasihatif/Data-Analysis-1-2-3/master/Data_Analysis_3/Assignment_1_DA3/data/raw/listings.csv")
data <- listings
```

```{r filter data, echo = FALSE, message=FALSE, warning=FALSE}
# Filter for apartments which accommodate 2-6 persons
data <- data %>%
  filter(property_type %in% c("Entire apartment", "Entire serviced apartment", "Entire home/apt", "Private room in apartment", "Private room in serviced apartment", "Shared room in apartment", "Room in serviced apartment")) %>%
  filter(between(accommodates, 2, 6))

```

```{r data cleaning 1, echo = FALSE, message=FALSE, warning=FALSE}
# Drop unnecessary columns
data <- data[grep("^host", colnames(data), invert = TRUE)]
data <- data[grep("^calculated", colnames(data), invert = TRUE)]
data <- data %>% dplyr::select(-contains("maximum"))
data <- data %>% select(-c("listing_url","scrape_id","last_scraped","name","description","neighborhood_overview","picture_url",
                           "neighbourhood_group_cleansed","bathrooms","minimum_minimum_nights", "minimum_nights_avg_ntm","calendar_updated",
                           "calendar_last_scraped","number_of_reviews_ltm","number_of_reviews_l30d","license","reviews_per_month",
                           "availability_30","availability_60","availability_90","availability_365","neighbourhood","has_availability"))

# Format amenities column. Remove square brackets and convert to vector
data$amenities<-gsub("\\[","",data$amenities)
data$amenities<-gsub("\\]","",data$amenities)
data$amenities<-gsub('\\"',"",data$amenities)
data$amenities <- as.list(strsplit(data$amenities, ","))
#define levels and dummies 
levs <- levels(factor(unlist(data$amenities)))
data <- cbind(data, as.data.frame(do.call(rbind, lapply(lapply(data$amenities, factor, levs), 
                                                        table))))
data <- data %>% select(-(224:273))

# Remove all whitespaces from column names
names(data) <- trimws(names(data))

# Repace all spaces between words with underscores
names(data) <- str_replace_all(names(data), " ", "_")

```

```{r checkpoint A, echo = FALSE}
#Checkpoint 1: Initial column cleaning
backup_a <- data
data <- backup_a
```

```{r data cleaning 2: amenities split, echo = FALSE}
# rename some columns for easier aggregation
names(data)[names(data) == "Mini_fridge"] <- "Mini_frige"
names(data)[names(data) == "Shower_gel"] <- "Shower_gel_soap"
names(data)[names(data) == "Barbecue_utensils"] <- "BBQ_utensils"
names(data)[names(data) == "Freezer"] <- "Freezer_frige"
names(data)[names(data) == "Free_residential_garage_on_premises"] <- "free_garage_parking"
names(data)[names(data) == "Amazon_Prime_Video"] <- "Amazon_Prime_TV"


# To eyeball the column names
amenities_clean_df <- sapply(data[25:193], function(x){sum(x)})
amenities_clean_df <- data.frame(amenities_clean_df)

# ------------------------------------------------------------------------------

### Updated aggregate_columns function code ###
# Example: Combine all sound system columns into 1 column.There are several different kinds of sound systems present.We would like to
# create one generic sound category.

# Pass a vector of phrases to the for loop to make the process quicker
column_names <- c("sound", "stove","Wifi","TV","oven","frige", "soap", "BBQ", "toys", "crib", "parking", "shampoo", "heating","washer","toiletries","conditioner","dry")

for( word in column_names){
  
  # Subset columns which contains a specific word and save them to another dataframe. Also select 'id' to use for merge later
  new_df <- data %>% select(contains(word),"id")
  
  #Go row by row to see if any of the rows have at least one '1'. If it does, populate new column 'col_name' with 1
  new_df$col_name <- apply(new_df[0:ncol(new_df)], 1, function(x) ifelse(any(x == 1), '1', '0'))
  
  # Save new column and id column to another dataframe. We use this new dataframe to merge with original dataframe
  new_df_merge <- new_df %>% select(id,col_name)
  
  #merge original dataframe and new_df_merge by 'id'
  data <- merge(data,new_df_merge,by = "id", all = FALSE)
  
  #remove the new column and 'id' column from the new_df dataframe
  new_df <- new_df %>% select(-c(id,col_name))
  
  # Remove the subset columns from original dataframe since they have already been aggregated into a new column and merged
  data <- data %>% select(-colnames(new_df))
  
  # Convert from character to integer
  data$col_name <- as.integer(data$col_name)
  
  # Rename new column
  names(data)[names(data) == 'col_name'] <- paste0(word,"_agg")
  
} 

```

```{r checkpoint B, echo = FALSE}
# Checkpoint 2:Subset data further for cleaning
backup_b <- data
data <- backup_b
```

```{r data cleaning 3, echo = FALSE}
# Subset all ameneties columns and remove any which have '1' less than 5%
amenities_clean <- data %>% select(25:125, "id")
less_than_5per <- amenities_clean %>% select(where(~mean(. == 1) <= 0.005))
less_than_5per <- less_than_5per %>% select(-contains(c("id")))
amenities_clean <- amenities_clean %>% select(-colnames(less_than_5per))

# Check for count
amenities_clean_df <- as.data.frame(sapply(amenities_clean, function(x){sum(x)}))

# Merge the original and amenities dataframe
data <- data %>% select(-(25:125))
data <- merge(data,amenities_clean, by = "id", all = FALSE)

#remove dollar signs from price variable. These prices are actually Euros
data$price<-gsub("\\$","",as.character(data$price))
data$price<-as.numeric(as.character(data$price))

data <- data %>% select(-c("amenities", "Babysitter_recommendations", "Baby_bath", "Baking_sheet"))

names(data)[names(data) == "frige_agg"] <- "refrigerator"
names(data)[names(data) == "neighbourhood_cleansed"] <- "neighbourhood"
names(data)[names(data) == "bathrooms_text"] <- "bathrooms"

# Remove text from bathrooms column
table(data$bathrooms)

data$bathrooms <- replace(data$bathrooms,data$bathrooms == '1 bath',1)
data$bathrooms <- replace(data$bathrooms,data$bathrooms == 'Half-bath',0.5)
data$bathrooms <- gsub("baths", "", data$bathrooms)
data$bathrooms <- as.numeric(data$bathrooms)

```

```{r checkpoint C, echo = FALSE}
backup_c <- data
data <- backup_c
```

```{r data cleaning 4, echo = FALSE}
## Create dummy variables using the fastdummies library

## Create dummy variables using the fastdummies library
data$instant_bookable <- replace(data$instant_bookable,data$instant_bookable == 'TRUE', "1")
data$instant_bookable <- replace(data$instant_bookable,data$instant_bookable == 'FALSE', "0")


# data <- data %>% dummy_cols(select_columns = "instant_bookable", remove_selected_columns = TRUE)
# data <- data  %>% select(-c("instant_bookable_f"))

# create dummy vars
dummies <- names(data)[seq(23,89)]

data <- data %>%
  mutate_at(vars(dummies), funs("d"= (.)))

dnames <- data %>%
  select(ends_with("_d")) %>%
  names()
dnames_i <- match(dnames, colnames(data))
colnames(data)[dnames_i] <- paste0("d_", tolower(gsub("[^[:alnum:]_]", "",dummies)))

# ------------------------------------------------------------------------------

# Convert room type to factor
table(data$room_type)

# Rename room type
data$room_type <- replace(data$room_type,data$room_type == 'Entire home/apt', "Entire_apt")
data$room_type <- replace(data$room_type,data$room_type == 'Hotel room', "Private room")
data$room_type <- replace(data$room_type,data$room_type == 'Private room', "Private_room")
data$room_type <- replace(data$room_type,data$room_type == 'Shared room', "Shared_room")

data <- data %>%
  mutate(f_room_type = factor(room_type))

# Convert neighbourhood_cleansed to factors
data <- data %>%
  mutate(
    f_neighbourhood = factor(neighbourhood))


# Property Type
table(data$property_type)

data$property_type <- replace(data$property_type,data$property_type == 'Entire apartment', 'Entire_apartment')
data$property_type <- replace(data$property_type,data$property_type == 'Entire home/apt', 'Entire_apartment')
data$property_type <- replace(data$property_type,data$property_type == 'Entire serviced apartment', 'Entire_apartment')
data$property_type <- replace(data$property_type,data$property_type == 'Room in serviced apartment', 'Room_apartment')
data$property_type <- replace(data$property_type,data$property_type == 'Private room in apartment', 'Room_apartment')
data$property_type <- replace(data$property_type,data$property_type == 'Private room in serviced apartment', 'Room_apartment')
data$property_type <- replace(data$property_type,data$property_type == 'Shared room in apartment', 'Room_apartment')


data <- data %>%
  mutate(f_property_type = factor(property_type))


# ------------------------------------------------------------------------------

# add new numeric columns from certain columns
numericals <- c("accommodates","bathrooms", "bedrooms", "beds","minimum_nights", "number_of_reviews", "review_scores_rating")
data <- data %>%
  mutate_at(vars(numericals), funs("n"=as.numeric))

# rename columns so they start with n_ as opposed to end with _n
nnames <- data %>%
  select(ends_with("_n")) %>%
  names()
nnames_i <- match(nnames, colnames(data))
colnames(data)[nnames_i] <- paste0("n_", numericals)

#-------------------------------------------------------------------------------

# keep columns if contain d_, n_,f_, p_, usd_ and some others
data <- data %>%
  select(id,price,matches("^d_.*|^n_.*|^f_.*"))


amenities_convert<- data %>%
  select(starts_with("d_"),"id") 

amenities_convert <- amenities_convert %>%mutate_if(is.integer,as.numeric)
glimpse(amenities_convert)

data <- data %>%
  select(-starts_with("d_")) 

data <- merge(data,amenities_convert, by = "id")

data <- data %>% mutate(id = as.numeric(id))
```

```{r checkpoint D, echo = FALSE}
backup_d <- data
data <- backup_d
```

```{r}

```

-   Executive summary/abstract

-   Introduction: aim of the analysis, what we can learn and possible other reports/analysis connection.

-   Data: what is your used data, data quality issues, descriptive statistics and graphs and variable transformation.

## **Introduction**

According to [Statistics Netherlands](https://opendata.cbs.nl/#/CBS/en/dataset/83913ENG/table) (CBS), Netherlands' house prices continue to rise strongly, buoyed by record low interest rates, with supply unable to keep up with strong demand. In Q1 2020, prices for apartments rose by 10.9%, to an average of â‚¬293,085 (US\$332,404). But many people have been willing to buy the apartments at higher rates due to the possibility of making extra money by renting the apartments out via Airbnb. It has become extremely popular, and lucrative, to rent out a flat or room here on one of the short-stay rental platforms, of which Airbnb is by far the biggest. An estimated 22,000 rooms and flats in the Dutch capital are now [offered for rent this way](https://www.amsterdam.nl/wonen-leefomgeving/wonen/nieuws-wonen/amsterdam-versterkt/#h80fede74-010e-487d-846c-949eb3dcc794) at least once a year. In the most popular neighborhoods, as many as one in six homeowners rent out a room or flat on Airbnb.

EU Heights is an upcoming Realtor who established their business in 2019 in Rotterdam. They have showed significant growth in 2020 and are now looking to expand into the Amsterdam market. With the increase in Airbnb listings in Amsterdam, EU Heights is looking to break into the Airbnb Amsterdam market and make a name for itself in the new city. They have hired me as a Data Science Consultant to study the Amsterdam market and help them with predicting the potential prices to keep for their rental apartments. I have to keep in mind the different neighborhoods of the city as well as the amenities provided in the apartment which can potentially affect the rental price.

## Data

*Data: what is your used data, data quality issues, descriptive statistics and graphs and variable
transformation.*

For this task, I have used the Airbnb data for Amsterdam that is available on [Inside Airbnb](www.insideairbnb.com) website. The dataset has a single table that includes 18522 observations. The data refers to rental prices for one night in December 2020. The target variable is price per night per person in Euros. The explanatory variables consist of several variables related to property reviews, host info and ratings, neighborhood etc.

Data Quality

Data Cleaning

### Descriptive Statistics

The two histograms below show the distribution of price and log price:

```{r price distribution, echo = FALSE, message = FALSE, warnin = FALSE}

# Price Distribution
price_hist <- ggplot(data, aes( x = price)) +
  geom_histogram(aes(y = (..count..)/sum(..count..)),fill = "cyan3", color = "black") +
  theme_bw() +
  scale_y_continuous(labels = label_percent()) +
  ylab("Percent") + 
  xlab("Price (Euros)")


ln_price_hist <- ggplot(data, aes( x = ln_price)) +
  geom_histogram(aes(y = (..count..)/sum(..count..)),fill = "grey", color = "black") +
  theme_bw() +
  scale_y_continuous(labels = label_percent()) +
  ylab("Percent") + 
  xlab("ln(Price, Euros)")

price_hist_grid <- ggarrange(
  price_hist,
  ln_price_hist,
  nrow = 1)

annotate_figure(price_hist_grid,bottom = text_grob("Note: Apartments with 2-6 accommodation capacity. Histogram without extreme values (price < 750 Euros) 
                                                   Data source: Inside Airbnb dataset, Amsterdam, Dec 2020", color = "black",vjust = 0.5,hjust = 1, x = 1, face = "italic", size = 10))

```

The distribution of Airbnb apartment prices is strongly skewed with a right long tail while the log of price is normally distributed. We will take the log of price in our prediction analysis.

The box plots below show that entire apartments on average cost more that private and shared rooms. The price of shared rooms on average is similar to that of private room but has a lot of variation partly due to less observations in the data. Similarly, the average price of apartments rises as the capacity to accommodate people rises.

```{r room type vs price , echo = FALSE, message = FALSE, warnin = FALSE}

# Room Type
room_type_box <- data %>% filter(price < 750) %>% ggplot(aes(x = f_room_type, y = price)) +
  stat_boxplot(aes(group = f_room_type), geom = "errorbar", width = 0.3,
               na.rm=T) +
  geom_boxplot(aes(group = f_room_type),
               size = 0.5, width = 0.6,  fill = c("cyan3","brown2", "mediumslateblue"),alpha = 0.3, na.rm=T, outlier.shape = NA) +
  scale_y_continuous(expand = c(0.01,0.01),limits = c(0,300), breaks = seq(0,300,100)) +
  labs(x = "Room type",y = "Price (Euros)")+
  theme_bw()

prop_with_accomm_box <- data %>% filter(price < 750) %>% ggplot(aes(x = factor(n_accommodates), y = price,
                        fill = f_property_type, color= f_property_type)) +
  geom_boxplot(alpha=0.8, na.rm=T, outlier.shape = NA, width = 0.8) +
 stat_boxplot(geom = "errorbar", width = 0.8, size = 0.3, na.rm=T)+
  labs(x = "Accomodates (Persons)",y = "Price (Euros)") +
  scale_y_continuous(expand = c(0.01,0.01), limits=c(0, 400), breaks = seq(0,400, 50)) +
  theme_bw() + theme(legend.position = c(0.15,0.9)) + theme(legend.title = element_blank())

price_prop_type <- ggarrange(
  room_type_box,
  prop_with_accomm_box,
  nrow = 1)

annotate_figure(price_prop_type,bottom = text_grob("Note: Box plots for price, graphs dont show extreme values
                                                   Data source: Inside Airbnb dataset, Amsterdam, Dec 2020", color = "black",vjust = 0.5,hjust = 1, x = 1, face = "italic", size = 10))

```
